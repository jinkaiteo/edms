# Staging Server - Complete Cleanup and Fresh Deployment Guide

## Summary

Complete instructions to clean up existing deployment and start fresh on staging server.

---

## Part 1: Pull Latest Code from GitHub

```bash
# SSH to staging server
ssh user@staging-server

# Navigate to project directory
cd /path/to/edms/

# Pull latest changes
git fetch origin
git checkout main
git pull origin main

# Verify you have the latest code
git log --oneline -5
# Should show recent commits including DB_PASSWORD fix (715d85a)
```

---

## Part 2: Stop All Containers

```bash
# Stop all EDMS containers
docker compose -f docker-compose.prod.yml down

# Or if using docker-compose (older version)
docker-compose -f docker-compose.prod.yml down

# Verify containers are stopped
docker compose -f docker-compose.prod.yml ps
# Should show no containers
```

---

## Part 3: Remove Containers, Images, Volumes, Networks

### Option A: Nuclear Cleanup (Removes EVERYTHING - Use with Caution!)

```bash
# WARNING: This removes ALL Docker resources, not just EDMS
# Only use if this server is dedicated to EDMS

# Stop all containers
docker stop $(docker ps -aq) 2>/dev/null || true

# Remove all containers
docker rm $(docker ps -aq) 2>/dev/null || true

# Remove all images
docker rmi $(docker images -q) 2>/dev/null || true

# Remove all volumes
docker volume prune -f

# Remove all networks (except default ones)
docker network prune -f

# Clean up everything
docker system prune -a --volumes -f
```

### Option B: Targeted Cleanup (Safer - Removes Only EDMS Resources)

```bash
# 1. Remove EDMS containers
docker compose -f docker-compose.prod.yml down -v

# 2. Remove EDMS images
docker images | grep qms_04 | awk '{print $3}' | xargs docker rmi -f 2>/dev/null || true
docker images | grep edms | awk '{print $3}' | xargs docker rmi -f 2>/dev/null || true

# 3. Remove EDMS volumes
docker volume ls | grep edms | awk '{print $2}' | xargs docker volume rm -f 2>/dev/null || true
docker volume ls | grep qms_04 | awk '{print $2}' | xargs docker volume rm -f 2>/dev/null || true

# 4. Remove EDMS networks
docker network ls | grep edms | awk '{print $1}' | xargs docker network rm 2>/dev/null || true
docker network ls | grep qms_04 | awk '{print $1}' | xargs docker network rm 2>/dev/null || true

# 5. Verify cleanup
echo "=== Remaining Containers ==="
docker ps -a

echo "=== Remaining Images ==="
docker images | grep -E "qms_04|edms"

echo "=== Remaining Volumes ==="
docker volume ls | grep -E "qms_04|edms"

echo "=== Remaining Networks ==="
docker network ls | grep -E "qms_04|edms"
```

---

## Part 4: Clean Up Cron Jobs

```bash
# 1. Check for existing EDMS cron jobs
crontab -l | grep -i edms

# 2. Edit crontab to remove EDMS jobs
crontab -e

# Remove any lines containing:
# - edms
# - backup
# - docker compose
# - Related to EDMS backup/restore

# 3. Verify cron jobs removed
crontab -l

# Should not show any EDMS-related entries
```

**If you have system-wide cron jobs (in /etc/cron.d/):**

```bash
# Check for EDMS cron files
ls -la /etc/cron.d/ | grep edms

# Remove if found
sudo rm /etc/cron.d/edms-* 2>/dev/null || true

# Check /etc/crontab
sudo cat /etc/crontab | grep edms

# Edit if needed
sudo nano /etc/crontab
```

---

## Part 5: Remove Local Files and Folders

```bash
# Still in /path/to/edms/

# 1. Remove .env file (will be regenerated by script)
rm -f .env
rm -f backend/.env

# 2. Remove database files (SQLite if any)
rm -f backend/*.sqlite3
rm -f backend/db.sqlite3
rm -f backend/edms*.sqlite3

# 3. Remove uploaded files and media
rm -rf backend/media/*
rm -rf backend/storage/*

# 4. Remove static files
rm -rf backend/staticfiles/*
rm -rf backend/static/collected/*

# 5. Remove Python cache
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -name "*.pyc" -delete 2>/dev/null || true

# 6. Remove log files
rm -f backend/*.log
rm -f *.log

# 7. Remove backup files (if you want fresh start)
rm -rf backend/storage_backup_*
rm -f *.json.backup
rm -f edms_*.json

# 8. Verify key files removed
echo "=== Checking cleanup ==="
ls -la .env 2>/dev/null && echo "⚠️ .env still exists" || echo "✅ .env removed"
ls -la backend/.env 2>/dev/null && echo "⚠️ backend/.env still exists" || echo "✅ backend/.env removed"
ls -la backend/*.sqlite3 2>/dev/null && echo "⚠️ SQLite files exist" || echo "✅ No SQLite files"
```

---

## Part 6: Verify Clean State

```bash
# 1. No Docker containers
docker ps -a
# Should show empty or no EDMS containers

# 2. No Docker volumes
docker volume ls
# Should not show edms volumes

# 3. No .env file
ls -la .env backend/.env
# Should show "No such file or directory"

# 4. No cron jobs
crontab -l | grep edms
# Should return nothing

# 5. Git status clean
git status
# Should show "nothing to commit, working tree clean"
```

---

## Part 7: Run Fresh Deployment

```bash
# Make sure you're in the EDMS directory
cd /path/to/edms/

# Make the script executable
chmod +x deploy-interactive.sh

# Run the interactive deployment script
./deploy-interactive.sh

# Follow the prompts:
# - Database name: edms_staging (or edms_production for prod)
# - Database user: edms_staging_user
# - Database password: (strong password - at least 12 chars)
# - Email SMTP host: smtp.gmail.com
# - Email port: 587
# - Email username: your-email@gmail.com
# - Email password: (app password)
# - Create test users: yes
```

---

## Part 8: Verify New Deployment

```bash
# 1. Check containers are running
docker compose -f docker-compose.prod.yml ps

# Should show all containers healthy:
# - edms_prod_backend (healthy)
# - edms_prod_frontend (healthy)
# - edms_prod_celery_worker (healthy)
# - edms_prod_celery_beat (running)
# - edms_prod_db (healthy)
# - edms_prod_redis (healthy)

# 2. Check .env file is correct
cat .env | grep "^DB_PASSWORD=" | cat -A
# Should show password on same line (no blank lines)

# 3. Test backend health
curl http://localhost:8001/health/
# Should return: {"status":"healthy"}

# 4. Test frontend
curl http://localhost:3001/
# Should return HTML

# 5. Check database
docker compose -f docker-compose.prod.yml exec backend \
  python manage.py shell -c "
from apps.documents.models import DocumentType
from django.contrib.auth import get_user_model
User = get_user_model()
print(f'Document Types: {DocumentType.objects.count()}')
print(f'Users: {User.objects.count()}')
"
# Should show:
# Document Types: 9
# Users: 4

# 6. Test email (if configured)
docker compose -f docker-compose.prod.yml exec backend \
  python manage.py shell -c "
from django.core.mail import send_mail
from django.conf import settings
send_mail(
    'EDMS Test',
    'Test email from fresh deployment',
    settings.DEFAULT_FROM_EMAIL,
    ['your-email@example.com']
)
print('Email sent!')
"
```

---

## Part 9: Access the Application

```bash
# Get your server's IP address
hostname -I | awk '{print $1}'

# Or
ip addr show | grep 'inet ' | grep -v '127.0.0.1'
```

**Access URLs:**
- Frontend: `http://your-server-ip:3001/`
- Backend API: `http://your-server-ip:8001/api/v1/`
- Backend Admin: `http://your-server-ip:8001/admin/`

**Login with:**
- Username: `admin`
- Password: `admin123`

---

## Troubleshooting

### If containers fail to start

```bash
# Check logs
docker compose -f docker-compose.prod.yml logs backend --tail=100
docker compose -f docker-compose.prod.yml logs frontend --tail=100

# Common issues:
# 1. Port conflicts - check if ports are in use
sudo netstat -tlnp | grep -E ':8001|:3001|:5433|:6380'

# 2. Permission issues - check storage permissions
ls -la backend/media backend/storage

# 3. Database connection - check .env password
docker compose -f docker-compose.prod.yml exec backend env | grep DB_
```

### If .env file has newlines (old bug)

```bash
# This should NOT happen with latest script, but if it does:
cat .env | grep "^DB_PASSWORD=" | cat -A

# If you see:
# DB_PASSWORD=$
# $
# password$

# Fix with:
./fix_staging_db_password.sh
```

---

## Complete Cleanup Command Summary

**Use this one-liner for complete cleanup (Targeted - Safer):**

```bash
cd /path/to/edms && \
docker compose -f docker-compose.prod.yml down -v && \
docker images | grep -E "qms_04|edms" | awk '{print $3}' | xargs docker rmi -f 2>/dev/null || true && \
docker volume ls | grep -E "qms_04|edms" | awk '{print $2}' | xargs docker volume rm -f 2>/dev/null || true && \
docker network ls | grep -E "qms_04|edms" | awk '{print $1}' | xargs docker network rm 2>/dev/null || true && \
rm -f .env backend/.env && \
rm -f backend/*.sqlite3 && \
rm -rf backend/media/* backend/storage/* backend/staticfiles/* && \
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
echo "✅ Cleanup complete!"
```

---

## Post-Deployment Checklist

After successful deployment:

- [ ] All containers running and healthy
- [ ] .env file has correct format (no newlines in passwords)
- [ ] Backend health check returns 200
- [ ] Frontend loads in browser
- [ ] Can login with admin/admin123
- [ ] Database has 9 document types
- [ ] Database has 4 test users
- [ ] Email notifications working (if configured)
- [ ] No cron jobs from old deployment
- [ ] No leftover Docker resources

---

**Date:** January 26, 2026  
**Purpose:** Fresh staging deployment with latest code  
**Includes:** DB_PASSWORD fix (commit 715d85a)  
**Status:** Ready for deployment testing
