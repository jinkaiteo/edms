# HAProxy Configuration for EDMS Staging Server
# Version: 2.8+
# Purpose: Single entry point on port 80 for frontend and backend services

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Security
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Statistics page (optional but useful)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:admin_changeme
    stats show-legends
    stats show-node

# Frontend - Main HTTP entry point on port 80
frontend http_frontend
    bind *:80
    mode http
    
    # Request logging
    option httplog
    option forwardfor
    
    # Security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # Health check endpoint (HAProxy responds directly)
    acl is_haproxy_health path /haproxy-health
    http-request return status 200 content-type text/plain string "HAProxy Healthy\n" if is_haproxy_health
    
    # Define ACLs for routing
    acl is_api path_beg /api/
    acl is_admin path_beg /admin/
    acl is_static path_beg /static/
    acl is_media path_beg /media/
    acl is_health path /health
    
    # Route to appropriate backend
    use_backend backend_django if is_api
    use_backend backend_django if is_admin
    use_backend backend_django if is_static
    use_backend backend_django if is_media
    use_backend backend_django if is_health
    
    # Default: route to frontend
    default_backend frontend_react

# Backend - Django API Server
backend backend_django
    mode http
    balance roundrobin
    
    # Health check
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Timeouts for API operations (some operations like backups may take longer)
    timeout server 120s
    timeout connect 5s
    
    # Backend server
    server django1 127.0.0.1:8001 check inter 5s rise 2 fall 3 maxconn 100
    
    # Optional: Add more Django instances for load balancing
    # server django2 127.0.0.1:8002 check inter 5s rise 2 fall 3 maxconn 100

# Backend - React Frontend
backend frontend_react
    mode http
    balance roundrobin
    
    # Health check
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Timeout settings
    timeout server 30s
    timeout connect 5s
    
    # Backend server
    server react1 127.0.0.1:3001 check inter 5s rise 2 fall 3 maxconn 100
    
    # Optional: Add more frontend instances for load balancing
    # server react2 127.0.0.1:3002 check inter 5s rise 2 fall 3 maxconn 100

# Optional: HTTPS Frontend (uncomment when SSL certificates are ready)
# frontend https_frontend
#     bind *:443 ssl crt /etc/ssl/private/edms-combined.pem
#     mode http
#     
#     # Security headers
#     http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     http-response set-header X-Frame-Options SAMEORIGIN
#     http-response set-header X-Content-Type-Options nosniff
#     http-response set-header X-XSS-Protection "1; mode=block"
#     
#     # ACLs for routing (same as HTTP)
#     acl is_api path_beg /api/
#     acl is_admin path_beg /admin/
#     acl is_static path_beg /static/
#     acl is_media path_beg /media/
#     
#     # Route to appropriate backend
#     use_backend backend_django if is_api
#     use_backend backend_django if is_admin
#     use_backend backend_django if is_static
#     use_backend backend_django if is_media
#     
#     # Default: route to frontend
#     default_backend frontend_react
