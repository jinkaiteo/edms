# Deploy-Interactive.sh - Comprehensive Analysis

## üìã Overview

**Script**: `deploy-interactive.sh`  
**Size**: 993 lines, 31KB  
**Purpose**: Interactive deployment script for EDMS with HAProxy support  
**Status**: Needs verification and potential fixes  

---

## üîç Script Structure Analysis

### Main Flow (Function: `main()` - Line 946)

```
1. preflight_checks()         - Verify Docker, disk space, etc.
2. collect_configuration()     - Interactive config collection
3. show_configuration_summary() - Review settings
4. create_env_file()           - Generate .env file
5. deploy_docker()             - Build and start containers
6. initialize_database()       - Run migrations and defaults
7. create_admin_user()         - Create superuser
8. test_deployment()           - Health checks
9. setup_haproxy()             - Optional HAProxy setup
10. show_final_summary()       - Display access info
```

---

## ‚úÖ Strengths

### 1. **Comprehensive Pre-flight Checks** (Line 174)
- ‚úÖ Docker installed and running
- ‚úÖ Docker Compose available
- ‚úÖ Disk space check (10GB+ recommended)
- ‚úÖ Python3 for key generation
- ‚úÖ Git (optional)

### 2. **Secure Configuration Generation**
- ‚úÖ Generates Django SECRET_KEY (50 chars)
- ‚úÖ Generates EDMS_MASTER_KEY (Fernet key for encryption)
- ‚úÖ Password validation (min 12 chars, confirmation required)
- ‚úÖ Sets .env file permissions to 600

### 3. **Complete Database Initialization** (Line 590)
```bash
1. Database migrations
2. Collect static files
3. Create default roles (7 roles)
4. Create default groups (6 groups)
5. Create test users
6. Create document types (6 types)
7. Create document sources (3 sources)
8. Initialize workflow defaults
9. Assign roles to test users
```

---

## ‚ö†Ô∏è Potential Issues & Fixes Needed

### Issue 1: Missing Docker Compose File Check

**Problem**: Script uses `docker-compose.prod.yml` but doesn't verify it exists.

**Line 556**: `docker compose -f docker-compose.prod.yml build`

**Fix Needed**:
```bash
# Add to preflight_checks():
if [ ! -f "$SCRIPT_DIR/docker-compose.prod.yml" ]; then
    print_error "docker-compose.prod.yml not found"
    exit 1
fi
```

---

### Issue 2: Script Dependencies Not Verified

**Problem**: Script calls external bash scripts without checking existence:

**Lines Referenced**:
- Line 636: `bash scripts/create-test-users.sh`
- Line 667: `bash scripts/initialize-workflow-defaults.sh`
- Line 677: `bash scripts/fix-reviewer-approver-roles.sh`

**Fix Needed**:
```bash
# Add function:
check_script_dependencies() {
    local required_scripts=(
        "scripts/create-test-users.sh"
        "scripts/initialize-workflow-defaults.sh"
        "scripts/fix-reviewer-approver-roles.sh"
    )
    
    for script in "${required_scripts[@]}"; do
        if [ ! -f "$SCRIPT_DIR/$script" ]; then
            print_error "Required script not found: $script"
            return 1
        fi
    done
    return 0
}
```

---

### Issue 3: Management Commands May Not Exist

**Problem**: Script assumes these Django management commands exist:

**Lines Referenced**:
- Line 616: `create_default_roles`
- Line 625: `create_default_groups`
- Line 647: `create_default_document_types`
- Line 656: `create_default_document_sources`

**Verification Needed**: Check if these commands exist in `backend/apps/*/management/commands/`

---

### Issue 4: Missing .env Placement

**Problem**: Script creates `.env` in script root (`$SCRIPT_DIR/.env` - Line 35), but backend expects it in `backend/.env`.

**Current**:
```bash
ENV_FILE="$SCRIPT_DIR/.env"  # Line 35
```

**Fix Needed**:
```bash
ENV_FILE="$SCRIPT_DIR/backend/.env"
# OR copy to both locations
cp "$ENV_FILE" "$BACKEND_DIR/.env"
```

---

### Issue 5: EDMS_MASTER_KEY Generation Requires cryptography

**Line 304**: 
```bash
EDMS_MASTER_KEY=$(python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode(), end='')")
```

**Problem**: May fail if `cryptography` package not installed on host.

**Fix Needed**:
```bash
# Add fallback:
EDMS_MASTER_KEY=$(python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode(), end='')" 2>/dev/null) || \
EDMS_MASTER_KEY=$(openssl rand -base64 32)
```

---

### Issue 6: Hardcoded Service Names

**Problem**: Script assumes specific database schema but uses inconsistent service names.

**Line 455**: `DB_HOST=postgres` (should be `db` to match docker-compose)

**Verification Needed**: Check docker-compose.prod.yml service names.

---

## üìù Required Configuration Files

### 1. **backend/.env** (Generated by script)

**Variables Set**:
```bash
SECRET_KEY                  # Django secret (50 chars)
DEBUG                       # False for production
ENVIRONMENT                 # production
ALLOWED_HOSTS              # IP, hostname, localhost
BACKEND_PORT               # Default: 8001
FRONTEND_PORT              # Default: 3001
POSTGRES_PORT              # Default: 5433
REDIS_PORT                 # Default: 6380
DB_NAME                    # Default: edms_production
DB_USER                    # Default: edms_prod_user
DB_PASSWORD                # User-provided (min 12 chars)
DB_HOST                    # postgres (‚ö†Ô∏è should be 'db'?)
DB_PORT                    # 5432 (internal)
REDIS_URL                  # redis://redis:6379/1
CELERY_BROKER_URL          # redis://redis:6379/0
CELERY_RESULT_BACKEND      # redis://redis:6379/0
EDMS_MASTER_KEY            # Fernet encryption key
CORS_ALLOWED_ORIGINS       # Based on HAProxy config
CSRF_TRUSTED_ORIGINS       # Same as CORS
SESSION_COOKIE_AGE         # User-provided (default: 3600)
EMAIL_BACKEND              # console backend
LOG_LEVEL                  # WARNING
JWT_ACCESS_TOKEN_LIFETIME_HOURS  # 8
JWT_REFRESH_TOKEN_LIFETIME_DAYS  # 1
DB_CONN_MAX_AGE           # 60
TZ                        # UTC
```

---

### 2. **docker-compose.prod.yml** (NOT generated, must exist)

**Required by script** but not created by it.

**Expected Services**:
- backend
- frontend  
- postgres (or db?)
- redis
- celery_worker (implied)
- celery_beat (implied)

---

### 3. **Supporting Scripts** (Must exist)

```bash
scripts/create-test-users.sh
scripts/initialize-workflow-defaults.sh
scripts/fix-reviewer-approver-roles.sh
```

---

## üîß Missing from Current Script

### 1. **No Backup of Existing Deployment**
Script doesn't backup existing containers/volumes before redeploying.

### 2. **No Rollback Mechanism**
If deployment fails halfway, no way to restore previous state.

### 3. **No Service Health Verification Loop**
Script waits 10 seconds then tests once. Should retry with timeout.

### 4. **No Frontend Environment Configuration**
Frontend may need its own .env file with `REACT_APP_API_URL`.

### 5. **No SSL/TLS Configuration**
Script mentions HAProxy but doesn't configure HTTPS.

---

## üìä Complete .env Template

Based on script analysis, here's what the generated .env should contain:

```bash
# ==============================================================================
# EDMS PRODUCTION ENVIRONMENT CONFIGURATION
# ==============================================================================

# DJANGO CORE
SECRET_KEY=<50-char-generated-key>
DEBUG=False
ENVIRONMENT=production
ALLOWED_HOSTS=<server-ip>,<hostname>,localhost,127.0.0.1

# DOCKER PORTS
BACKEND_PORT=8001
FRONTEND_PORT=3001
POSTGRES_PORT=5433
REDIS_PORT=6380

# DATABASE
DB_NAME=edms_production
DB_USER=edms_prod_user
DB_PASSWORD=<user-provided>
DB_HOST=db  # ‚ö†Ô∏è Script says 'postgres'
DB_PORT=5432

# REDIS
REDIS_URL=redis://redis:6379/1
REDIS_PASSWORD=

# CELERY
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0
CELERY_ALWAYS_EAGER=False

# ENCRYPTION
EDMS_MASTER_KEY=<44-char-fernet-key>

# CORS & SECURITY
CORS_ALLOWED_ORIGINS=http://<server-ip>,http://<hostname>
CSRF_TRUSTED_ORIGINS=http://<server-ip>,http://<hostname>
SESSION_COOKIE_AGE=3600
SESSION_COOKIE_HTTPONLY=True
SESSION_COOKIE_SAMESITE=Lax
CSRF_COOKIE_HTTPONLY=True
CSRF_COOKIE_SAMESITE=Lax

# EMAIL
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend

# LOGGING
LOG_LEVEL=WARNING

# JWT
JWT_ACCESS_TOKEN_LIFETIME_HOURS=8
JWT_REFRESH_TOKEN_LIFETIME_DAYS=1
JWT_ROTATE_REFRESH_TOKENS=True

# PERFORMANCE
DB_CONN_MAX_AGE=60
DB_MAX_CONNECTIONS=20
CACHE_TTL=900

# LOCALIZATION
TZ=UTC
LANGUAGE_CODE=en-us

# OPTIONAL
# SENTRY_DSN=<if-configured>
```

---

## ‚úÖ What Script Does Well

1. ‚úÖ **Interactive and user-friendly** with colored output
2. ‚úÖ **Generates secure secrets** automatically
3. ‚úÖ **Validates passwords** (12+ chars, confirmation)
4. ‚úÖ **Backs up existing .env** before overwriting
5. ‚úÖ **Comprehensive database initialization**
6. ‚úÖ **Tests deployment** after completion
7. ‚úÖ **Clear summary** with access URLs
8. ‚úÖ **HAProxy integration option**

---

## üî¥ Critical Issues to Fix Before Running

### Priority 1: CRITICAL
1. ‚ö†Ô∏è **Verify DB_HOST value** (postgres vs db)
2. ‚ö†Ô∏è **Check if docker-compose.prod.yml exists**
3. ‚ö†Ô∏è **Verify all script dependencies exist**
4. ‚ö†Ô∏è **Verify .env file placement** (root vs backend/)

### Priority 2: HIGH
5. ‚ö†Ô∏è **Check all management commands exist**
6. ‚ö†Ô∏è **Add fallback for EDMS_MASTER_KEY generation**
7. ‚ö†Ô∏è **Add health check retry loop**

### Priority 3: MEDIUM
8. ‚ö†Ô∏è **Add frontend .env generation**
9. ‚ö†Ô∏è **Add deployment backup mechanism**
10. ‚ö†Ô∏è **Improve error recovery**

---

## üéØ Recommended Next Steps

1. **Verify Prerequisites**
   ```bash
   # Check if files exist:
   ls -la docker-compose.prod.yml
   ls -la scripts/create-test-users.sh
   ls -la scripts/initialize-workflow-defaults.sh
   ls -la scripts/fix-reviewer-approver-roles.sh
   ```

2. **Check Management Commands**
   ```bash
   docker compose exec backend python manage.py --help | grep -E "create_default|fix_reviewer"
   ```

3. **Test Docker Compose**
   ```bash
   docker compose -f docker-compose.prod.yml config
   ```

4. **Create Fixed Version**
   - Fix DB_HOST value
   - Add prerequisite checks
   - Add .env placement logic
   - Add error recovery

---

## üìà Script Health Assessment

| Category | Score | Notes |
|----------|-------|-------|
| **Structure** | 9/10 | Well-organized, clear flow |
| **Error Handling** | 7/10 | Has trap, but limited recovery |
| **Documentation** | 9/10 | Excellent comments and output |
| **Prerequisites** | 5/10 | Missing critical file checks |
| **Security** | 8/10 | Good secret generation, file perms |
| **Robustness** | 6/10 | No retry logic, limited validation |
| **User Experience** | 10/10 | Excellent interactive prompts |

**Overall: 7.7/10** - Good script, needs prerequisite verification fixes

---

## üöÄ Quick Fix Checklist

Before running deploy-interactive.sh:

- [ ] Verify docker-compose.prod.yml exists
- [ ] Check DB_HOST matches docker-compose service name
- [ ] Verify all script dependencies exist
- [ ] Check all management commands are available
- [ ] Test cryptography package available
- [ ] Verify .env will be placed correctly
- [ ] Have backup plan ready
- [ ] Review generated HAProxy config

---

**Recommendation**: Fix critical issues (Priority 1) before attempting deployment.

