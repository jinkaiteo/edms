# EDMS GitLab CI/CD Pipeline
# Complete deployment pipeline with automated testing and rollback

stages:
  - validate
  - test
  - package
  - deploy-staging
  - deploy-production
  - monitor

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  PACKAGE_NAME: "edms-production-${CI_COMMIT_SHORT_SHA}"

# ============================================================================
# TEMPLATES
# ============================================================================

.ssh_setup: &ssh_setup
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SSH_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

.deployment_template: &deployment_template
  <<: *ssh_setup
  script:
    - chmod +x scripts/deploy-to-remote.sh
    - |
      ./scripts/deploy-to-remote.sh \
        ${SSH_USER}@${SSH_HOST} \
        --key ~/.ssh/id_rsa \
        --path /opt/edms \
        --verbose
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-production-* && ./scripts/post-deploy-check.sh'
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-production-* && ./scripts/health-check.sh --alert'

# ============================================================================
# STAGE 1: VALIDATION
# ============================================================================

pre-deployment-checks:
  stage: validate
  image: ubuntu:22.04
  before_script:
    - apt-get update -y
    - apt-get install -y curl docker.io docker-compose
  script:
    - echo "Running pre-deployment verification..."
    - chmod +x scripts/create-production-package.sh
    - ./scripts/create-production-package.sh
    - chmod +x scripts/pre-deploy-check.sh
    - ./scripts/pre-deploy-check.sh edms-production-*/
  artifacts:
    paths:
      - edms-production-*.tar.gz
      - edms-production-*/pre-deployment-report-*.txt
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests

code-quality:
  stage: validate
  image: python:3.11
  script:
    - pip install flake8 black pylint
    - cd backend
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
    - black --check . || true
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ============================================================================
# STAGE 2: TESTING
# ============================================================================

backend-tests:
  stage: test
  image: python:3.11
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_DB: edms_test
    POSTGRES_USER: edms
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: "postgresql://edms:test_password@postgres:5432/edms_test"
    REDIS_URL: "redis://redis:6379/0"
  before_script:
    - cd backend
    - pip install -r requirements/test.txt
  script:
    - python manage.py test
    - python manage.py check --deploy
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: backend/test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
  only:
    - main
    - develop
    - merge_requests

frontend-tests:
  stage: test
  image: node:20
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint || true
    - npm test -- --watchAll=false --coverage
    - npm run build
  artifacts:
    paths:
      - frontend/build/
      - frontend/coverage/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests

security-scan:
  stage: test
  image: python:3.11
  before_script:
    - pip install safety bandit
  script:
    - cd backend
    - safety check --json || true
    - bandit -r . -f json -o bandit-report.json || true
  artifacts:
    reports:
      sast: backend/bandit-report.json
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ============================================================================
# STAGE 3: PACKAGE
# ============================================================================

create-deployment-package:
  stage: package
  image: ubuntu:22.04
  before_script:
    - apt-get update -y
    - apt-get install -y tar gzip
  script:
    - chmod +x scripts/create-production-package.sh
    - ./scripts/create-production-package.sh
    - ls -lh edms-production-*.tar.gz
  artifacts:
    paths:
      - edms-production-*.tar.gz
      - edms-production-*/MANIFEST.txt
      - edms-production-*/checksums.sha256
    expire_in: 30 days
  only:
    - main
    - develop

# ============================================================================
# STAGE 4: DEPLOY TO STAGING
# ============================================================================

deploy-staging:
  stage: deploy-staging
  image: ubuntu:22.04
  variables:
    SSH_HOST: $STAGING_HOST
    SSH_USER: $STAGING_USER
    SSH_PRIVATE_KEY: $STAGING_SSH_KEY
  <<: *deployment_template
  environment:
    name: staging
    url: https://staging.edms.example.com
    on_stop: stop-staging
  artifacts:
    paths:
      - staging-validation-report.txt
      - staging-health-report.html
    expire_in: 30 days
    when: always
  only:
    - develop
  needs:
    - backend-tests
    - frontend-tests
    - create-deployment-package

stop-staging:
  stage: deploy-staging
  image: ubuntu:22.04
  variables:
    SSH_HOST: $STAGING_HOST
    SSH_USER: $STAGING_USER
    SSH_PRIVATE_KEY: $STAGING_SSH_KEY
  <<: *ssh_setup
  script:
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-production-* && docker compose down'
  environment:
    name: staging
    action: stop
  when: manual
  only:
    - develop

staging-smoke-tests:
  stage: deploy-staging
  image: ubuntu:22.04
  variables:
    SSH_HOST: $STAGING_HOST
    SSH_USER: $STAGING_USER
    SSH_PRIVATE_KEY: $STAGING_SSH_KEY
  <<: *ssh_setup
  script:
    - echo "Running smoke tests on staging..."
    - |
      for i in {1..3}; do
        echo "Health check $i/3..."
        ssh ${SSH_USER}@${SSH_HOST} \
          'cd /opt/edms-production-* && ./scripts/health-check.sh --quick' || exit 1
        sleep 30
      done
    - echo "✅ Staging smoke tests passed"
  only:
    - develop
  needs:
    - deploy-staging

# ============================================================================
# STAGE 5: DEPLOY TO PRODUCTION
# ============================================================================

deploy-production:
  stage: deploy-production
  image: ubuntu:22.04
  variables:
    SSH_HOST: $PRODUCTION_HOST
    SSH_USER: $PRODUCTION_USER
    SSH_PRIVATE_KEY: $PRODUCTION_SSH_KEY
  <<: *ssh_setup
  script:
    # Create backup
    - echo "Creating pre-deployment backup..."
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-current && ./scripts/backup-system.sh' || echo "Backup failed"
    
    # Deploy
    - chmod +x scripts/deploy-to-remote.sh
    - |
      ./scripts/deploy-to-remote.sh \
        ${SSH_USER}@${SSH_HOST} \
        --key ~/.ssh/id_rsa \
        --path /opt/edms \
        --verbose
    
    # Validate
    - echo "Running post-deployment validation..."
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-production-* && ./scripts/post-deploy-check.sh'
    
    # Health check
    - echo "Running health check..."
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-production-* && ./scripts/health-check.sh --alert --report'
    
    # Download reports
    - |
      scp ${SSH_USER}@${SSH_HOST}:/opt/edms-production-*/post-deployment-report-*.txt \
        ./production-validation-report.txt || true
    - |
      scp ${SSH_USER}@${SSH_HOST}:/opt/edms-production-*/health-report-*.html \
        ./production-health-report.html || true
  
  after_script:
    # Rollback on failure
    - |
      if [ $CI_JOB_STATUS != 'success' ]; then
        echo "⚠️ Deployment failed! Initiating rollback..."
        ssh ${SSH_USER}@${SSH_HOST} \
          'cd /opt/edms-production-* && ./scripts/rollback.sh --previous --backup-first --force'
        
        echo "Verifying rollback..."
        ssh ${SSH_USER}@${SSH_HOST} \
          'cd /opt/edms-production-* && ./scripts/health-check.sh --alert'
      fi
  
  environment:
    name: production
    url: https://edms.example.com
  
  artifacts:
    paths:
      - production-validation-report.txt
      - production-health-report.html
    expire_in: 90 days
    when: always
  
  only:
    - main
  
  when: manual
  
  needs:
    - backend-tests
    - frontend-tests
    - create-deployment-package

# ============================================================================
# STAGE 6: POST-DEPLOYMENT MONITORING
# ============================================================================

monitor-production:
  stage: monitor
  image: ubuntu:22.04
  variables:
    SSH_HOST: $PRODUCTION_HOST
    SSH_USER: $PRODUCTION_USER
    SSH_PRIVATE_KEY: $PRODUCTION_SSH_KEY
  <<: *ssh_setup
  script:
    - echo "Monitoring production system for 5 minutes..."
    - |
      for i in {1..5}; do
        echo "Health check $i/5..."
        ssh ${SSH_USER}@${SSH_HOST} \
          'cd /opt/edms-production-* && ./scripts/health-check.sh --quick' || exit 1
        
        if [ $i -lt 5 ]; then
          sleep 60
        fi
      done
    
    - echo "✅ System stable after 5 minutes"
    
    # Generate final report
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-production-* && ./scripts/health-check.sh --report'
    
    # Download final report
    - |
      scp ${SSH_USER}@${SSH_HOST}:/opt/edms-production-*/health-report-*.html \
        ./production-final-health-report.html || true
  
  artifacts:
    paths:
      - production-final-health-report.html
    expire_in: 90 days
    when: always
  
  only:
    - main
  
  needs:
    - deploy-production

monitor-staging:
  stage: monitor
  image: ubuntu:22.04
  variables:
    SSH_HOST: $STAGING_HOST
    SSH_USER: $STAGING_USER
    SSH_PRIVATE_KEY: $STAGING_SSH_KEY
  <<: *ssh_setup
  script:
    - echo "Monitoring staging system..."
    - |
      for i in {1..3}; do
        echo "Health check $i/3..."
        ssh ${SSH_USER}@${SSH_HOST} \
          'cd /opt/edms-production-* && ./scripts/health-check.sh --quick'
        
        if [ $i -lt 3 ]; then
          sleep 60
        fi
      done
  
  only:
    - develop
  
  needs:
    - deploy-staging
  
  allow_failure: true

# ============================================================================
# SCHEDULED JOBS
# ============================================================================

daily-health-check:
  stage: monitor
  image: ubuntu:22.04
  variables:
    SSH_HOST: $PRODUCTION_HOST
    SSH_USER: $PRODUCTION_USER
    SSH_PRIVATE_KEY: $PRODUCTION_SSH_KEY
  <<: *ssh_setup
  script:
    - |
      ssh ${SSH_USER}@${SSH_HOST} \
        'cd /opt/edms-current && ./scripts/health-check.sh --report'
    - |
      scp ${SSH_USER}@${SSH_HOST}:/opt/edms-current/health-report-*.html \
        ./daily-health-report.html
  
  artifacts:
    paths:
      - daily-health-report.html
    expire_in: 7 days
  
  only:
    - schedules
