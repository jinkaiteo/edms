import React, { useState, useCallback, useEffect } from 'react';\nimport { useAuth } from '../../contexts/AuthContext';\nimport apiService from '../../services/api';\nimport LoadingSpinner from '../common/LoadingSpinner';\n\ninterface WorkflowTask {\n  id: string;\n  uuid: string;\n  name: string;\n  description: string;\n  task_type: 'REVIEW' | 'APPROVE' | 'VALIDATE' | 'SIGN' | 'NOTIFY' | 'CUSTOM';\n  priority: 'LOW' | 'NORMAL' | 'HIGH' | 'URGENT';\n  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'SKIPPED' | 'CANCELLED' | 'FAILED';\n  assigned_to: number;\n  assigned_by: number;\n  created_at: string;\n  due_date: string | null;\n  started_at: string | null;\n  completed_at: string | null;\n  completion_note: string;\n  workflow_instance: {\n    id: string;\n    workflow_type: {\n      name: string;\n      description: string;\n    };\n    content_object: {\n      title: string;\n      document_number: string;\n    };\n  };\n  task_data: any;\n}\n\ninterface TaskFilters {\n  status?: string;\n  priority?: string;\n  task_type?: string;\n  due_date_range?: 'today' | 'week' | 'month' | 'overdue';\n}\n\ninterface MyTasksProps {\n  className?: string;\n}\n\nconst MyTasks: React.FC<MyTasksProps> = ({ className = '' }) => {\n  const [tasks, setTasks] = useState<WorkflowTask[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [selectedTask, setSelectedTask] = useState<WorkflowTask | null>(null);\n  const [actionLoading, setActionLoading] = useState(false);\n  const [filters, setFilters] = useState<TaskFilters>({});\n  const [showCompleteModal, setShowCompleteModal] = useState(false);\n  const [completionNote, setCompletionNote] = useState('');\n  const { user } = useAuth();\n\n  // Load user's assigned tasks\n  useEffect(() => {\n    const loadTasks = async () => {\n      try {\n        setLoading(true);\n        setError(null);\n        \n        // In production, this would call the actual API\n        // For now, we'll simulate with mock data and real workflow instances\n        try {\n          // Try to get real workflow instances\n          const workflowData = await apiService.get('/workflows/instances/');\n          \n          // Convert workflow instances to task format for demo\n          const mockTasks: WorkflowTask[] = workflowData.map((instance: any, index: number) => ({\n            id: `task-${instance.id || index}`,\n            uuid: instance.uuid || `uuid-${index}`,\n            name: `Review ${instance.content_object?.title || 'Document'}`,\n            description: `Review and provide feedback on ${instance.content_object?.title || 'document'}`,\n            task_type: 'REVIEW' as const,\n            priority: 'NORMAL' as const,\n            status: 'PENDING' as const,\n            assigned_to: user?.id || 1,\n            assigned_by: 1,\n            created_at: instance.started_at || new Date().toISOString(),\n            due_date: instance.due_date || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),\n            started_at: null,\n            completed_at: null,\n            completion_note: '',\n            workflow_instance: {\n              id: instance.id || `instance-${index}`,\n              workflow_type: {\n                name: instance.workflow_type?.name || 'Document Review Workflow',\n                description: instance.workflow_type?.description || 'Standard document review process'\n              },\n              content_object: {\n                title: instance.content_object?.title || `Document ${index + 1}`,\n                document_number: instance.content_object?.document_number || `DOC-${String(index + 1).padStart(3, '0')}`\n              }\n            },\n            task_data: {}\n          }));\n          \n          setTasks(mockTasks);\n        } catch (apiError) {\n          console.log('MyTasks: Using fallback mock data');\n          \n          // Fallback to complete mock data\n          const fallbackTasks: WorkflowTask[] = [\n            {\n              id: 'task-1',\n              uuid: 'task-uuid-1',\n              name: 'Review Quality Manual v2.1',\n              description: 'Review and provide feedback on the updated quality manual document',\n              task_type: 'REVIEW',\n              priority: 'HIGH',\n              status: 'PENDING',\n              assigned_to: user?.id || 1,\n              assigned_by: 2,\n              created_at: new Date().toISOString(),\n              due_date: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),\n              started_at: null,\n              completed_at: null,\n              completion_note: '',\n              workflow_instance: {\n                id: 'wf-1',\n                workflow_type: {\n                  name: 'Document Review Workflow',\n                  description: 'Standard 30-day document review process'\n                },\n                content_object: {\n                  title: 'Quality Manual v2.1',\n                  document_number: 'QM-001'\n                }\n              },\n              task_data: {}\n            },\n            {\n              id: 'task-2',\n              uuid: 'task-uuid-2',\n              name: 'Approve SOP Update',\n              description: 'Final approval required for Standard Operating Procedure #042',\n              task_type: 'APPROVE',\n              priority: 'NORMAL',\n              status: 'PENDING',\n              assigned_to: user?.id || 1,\n              assigned_by: 3,\n              created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),\n              due_date: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),\n              started_at: null,\n              completed_at: null,\n              completion_note: '',\n              workflow_instance: {\n                id: 'wf-2',\n                workflow_type: {\n                  name: 'Document Approval Workflow',\n                  description: 'Final approval process for reviewed documents'\n                },\n                content_object: {\n                  title: 'Data Backup SOP v1.3',\n                  document_number: 'SOP-042'\n                }\n              },\n              task_data: {}\n            }\n          ];\n          \n          setTasks(fallbackTasks);\n        }\n      } catch (err: any) {\n        console.error('Error loading tasks:', err);\n        setError('Failed to load tasks');\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    loadTasks();\n  }, [user]);\n\n  // Filter tasks based on current filters\n  const filteredTasks = tasks.filter(task => {\n    if (filters.status && task.status !== filters.status) return false;\n    if (filters.priority && task.priority !== filters.priority) return false;\n    if (filters.task_type && task.task_type !== filters.task_type) return false;\n    \n    if (filters.due_date_range) {\n      const now = new Date();\n      const dueDate = new Date(task.due_date || '');\n      \n      switch (filters.due_date_range) {\n        case 'today':\n          if (dueDate.toDateString() !== now.toDateString()) return false;\n          break;\n        case 'week':\n          const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);\n          if (dueDate > weekFromNow) return false;\n          break;\n        case 'month':\n          const monthFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);\n          if (dueDate > monthFromNow) return false;\n          break;\n        case 'overdue':\n          if (dueDate >= now) return false;\n          break;\n      }\n    }\n    \n    return true;\n  });\n\n  const handleTaskAction = useCallback(async (task: WorkflowTask, action: 'start' | 'complete' | 'skip') => {\n    setActionLoading(true);\n    \n    try {\n      if (action === 'start') {\n        // Update task to in-progress\n        const updatedTasks = tasks.map(t => \n          t.id === task.id \n            ? { ...t, status: 'IN_PROGRESS' as const, started_at: new Date().toISOString() }\n            : t\n        );\n        setTasks(updatedTasks);\n      } else if (action === 'complete') {\n        setSelectedTask(task);\n        setShowCompleteModal(true);\n      } else if (action === 'skip') {\n        // Update task to skipped\n        const updatedTasks = tasks.map(t => \n          t.id === task.id \n            ? { ...t, status: 'SKIPPED' as const, completed_at: new Date().toISOString() }\n            : t\n        );\n        setTasks(updatedTasks);\n      }\n    } catch (err: any) {\n      setError(`Failed to ${action} task`);\n    } finally {\n      setActionLoading(false);\n    }\n  }, [tasks]);\n\n  const handleCompleteTask = useCallback(async () => {\n    if (!selectedTask) return;\n    \n    setActionLoading(true);\n    \n    try {\n      // Update task to completed\n      const updatedTasks = tasks.map(t => \n        t.id === selectedTask.id \n          ? { \n              ...t, \n              status: 'COMPLETED' as const, \n              completed_at: new Date().toISOString(),\n              completion_note: completionNote\n            }\n          : t\n      );\n      setTasks(updatedTasks);\n      \n      // Close modal and reset\n      setShowCompleteModal(false);\n      setSelectedTask(null);\n      setCompletionNote('');\n    } catch (err: any) {\n      setError('Failed to complete task');\n    } finally {\n      setActionLoading(false);\n    }\n  }, [selectedTask, completionNote, tasks]);\n\n  const formatRelativeTime = (dateString: string) => {\n    const now = new Date();\n    const date = new Date(dateString);\n    const diffInHours = Math.floor((date.getTime() - now.getTime()) / (1000 * 60 * 60));\n    \n    if (diffInHours < 0) {\n      const overdueDays = Math.floor(-diffInHours / 24);\n      return overdueDays === 0 ? 'Due today' : `${overdueDays} day${overdueDays > 1 ? 's' : ''} overdue`;\n    } else if (diffInHours < 24) {\n      return diffInHours === 0 ? 'Due now' : `Due in ${diffInHours} hour${diffInHours > 1 ? 's' : ''}`;\n    } else {\n      const daysRemaining = Math.floor(diffInHours / 24);\n      return `Due in ${daysRemaining} day${daysRemaining > 1 ? 's' : ''}`;\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case 'URGENT': return 'bg-red-100 text-red-800 border-red-200';\n      case 'HIGH': return 'bg-orange-100 text-orange-800 border-orange-200';\n      case 'NORMAL': return 'bg-blue-100 text-blue-800 border-blue-200';\n      case 'LOW': return 'bg-gray-100 text-gray-800 border-gray-200';\n      default: return 'bg-gray-100 text-gray-800 border-gray-200';\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'PENDING': return 'bg-yellow-100 text-yellow-800';\n      case 'IN_PROGRESS': return 'bg-blue-100 text-blue-800';\n      case 'COMPLETED': return 'bg-green-100 text-green-800';\n      case 'SKIPPED': return 'bg-gray-100 text-gray-800';\n      case 'CANCELLED': return 'bg-red-100 text-red-800';\n      default: return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getTaskTypeIcon = (taskType: string) => {\n    switch (taskType) {\n      case 'REVIEW': return 'üìã';\n      case 'APPROVE': return '‚úÖ';\n      case 'VALIDATE': return 'üîç';\n      case 'SIGN': return '‚úçÔ∏è';\n      case 'NOTIFY': return 'üì¢';\n      default: return 'üìå';\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className={`flex justify-center items-center py-8 ${className}`}>\n        <LoadingSpinner />\n      </div>\n    );\n  }\n\n  return (\n    <div className={`space-y-6 ${className}`}>\n      {/* Header */}\n      <div className=\"flex justify-between items-start\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-gray-900\">My Tasks</h2>\n          <p className=\"text-gray-600 mt-1\">\n            {filteredTasks.length} task{filteredTasks.length !== 1 ? 's' : ''} assigned to you\n          </p>\n        </div>\n        \n        {/* Task Summary Stats */}\n        <div className=\"flex space-x-4\">\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-yellow-600\">\n              {tasks.filter(t => t.status === 'PENDING').length}\n            </div>\n            <div className=\"text-xs text-gray-500\">Pending</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-blue-600\">\n              {tasks.filter(t => t.status === 'IN_PROGRESS').length}\n            </div>\n            <div className=\"text-xs text-gray-500\">In Progress</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-green-600\">\n              {tasks.filter(t => t.status === 'COMPLETED').length}\n            </div>\n            <div className=\"text-xs text-gray-500\">Completed</div>\n          </div>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <div className=\"bg-white p-4 rounded-lg shadow-sm border border-gray-200\">\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Status\n            </label>\n            <select\n              value={filters.status || ''}\n              onChange={(e) => setFilters({ ...filters, status: e.target.value || undefined })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md text-sm\"\n            >\n              <option value=\"\">All Statuses</option>\n              <option value=\"PENDING\">Pending</option>\n              <option value=\"IN_PROGRESS\">In Progress</option>\n              <option value=\"COMPLETED\">Completed</option>\n              <option value=\"SKIPPED\">Skipped</option>\n            </select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Priority\n            </label>\n            <select\n              value={filters.priority || ''}\n              onChange={(e) => setFilters({ ...filters, priority: e.target.value || undefined })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md text-sm\"\n            >\n              <option value=\"\">All Priorities</option>\n              <option value=\"URGENT\">Urgent</option>\n              <option value=\"HIGH\">High</option>\n              <option value=\"NORMAL\">Normal</option>\n              <option value=\"LOW\">Low</option>\n            </select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Task Type\n            </label>\n            <select\n              value={filters.task_type || ''}\n              onChange={(e) => setFilters({ ...filters, task_type: e.target.value || undefined })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md text-sm\"\n            >\n              <option value=\"\">All Types</option>\n              <option value=\"REVIEW\">Review</option>\n              <option value=\"APPROVE\">Approve</option>\n              <option value=\"VALIDATE\">Validate</option>\n              <option value=\"SIGN\">Sign</option>\n            </select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Due Date\n            </label>\n            <select\n              value={filters.due_date_range || ''}\n              onChange={(e) => setFilters({ ...filters, due_date_range: e.target.value as any || undefined })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md text-sm\"\n            >\n              <option value=\"\">All Dates</option>\n              <option value=\"overdue\">Overdue</option>\n              <option value=\"today\">Due Today</option>\n              <option value=\"week\">Due This Week</option>\n              <option value=\"month\">Due This Month</option>\n            </select>\n          </div>\n        </div>\n      </div>\n\n      {/* Error Display */}\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n          <div className=\"flex\">\n            <div className=\"flex-shrink-0\">\n              <svg className=\"h-5 w-5 text-red-400\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clipRule=\"evenodd\" />\n              </svg>\n            </div>\n            <div className=\"ml-3\">\n              <p className=\"text-sm text-red-700\">{error}</p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Tasks List */}\n      {filteredTasks.length === 0 ? (\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center\">\n          <div className=\"text-6xl mb-4\">üìã</div>\n          <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n            No tasks found\n          </h3>\n          <p className=\"text-gray-500\">\n            {tasks.length === 0 \n              ? \"You don't have any tasks assigned yet.\" \n              : \"No tasks match your current filters.\"}\n          </p>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {filteredTasks.map((task) => {\n            const isOverdue = task.due_date && new Date(task.due_date) < new Date();\n            \n            return (\n              <div \n                key={task.id} \n                className={`bg-white rounded-lg shadow-sm border-2 p-6 ${\n                  isOverdue && task.status === 'PENDING' \n                    ? 'border-red-200 bg-red-50' \n                    : 'border-gray-200 hover:border-blue-200'\n                } transition-colors duration-200`}\n              >\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"text-2xl\">\n                        {getTaskTypeIcon(task.task_type)}\n                      </div>\n                      \n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <h3 className=\"text-lg font-medium text-gray-900 truncate\">\n                            {task.name}\n                          </h3>\n                          \n                          <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${getPriorityColor(task.priority)}`}>\n                            {task.priority}\n                          </span>\n                          \n                          <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(task.status)}`}>\n                            {task.status.replace('_', ' ')}\n                          </span>\n                        </div>\n                        \n                        <p className=\"text-sm text-gray-600 mb-3\">\n                          {task.description}\n                        </p>\n                        \n                        <div className=\"flex items-center space-x-4 text-sm text-gray-500\">\n                          <div className=\"flex items-center space-x-1\">\n                            <span>üìÑ</span>\n                            <span>{task.workflow_instance.content_object.title}</span>\n                          </div>\n                          \n                          <div className=\"flex items-center space-x-1\">\n                            <span>üîÑ</span>\n                            <span>{task.workflow_instance.workflow_type.name}</span>\n                          </div>\n                          \n                          {task.due_date && (\n                            <div className={`flex items-center space-x-1 ${\n                              isOverdue ? 'text-red-600 font-medium' : ''\n                            }`}>\n                              <span>‚è∞</span>\n                              <span>{formatRelativeTime(task.due_date)}</span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  \n                  {/* Action Buttons */}\n                  <div className=\"flex items-center space-x-2 ml-4\">\n                    {task.status === 'PENDING' && (\n                      <>\n                        <button\n                          onClick={() => handleTaskAction(task, 'start')}\n                          disabled={actionLoading}\n                          className=\"inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50\"\n                        >\n                          Start\n                        </button>\n                        <button\n                          onClick={() => handleTaskAction(task, 'skip')}\n                          disabled={actionLoading}\n                          className=\"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50\"\n                        >\n                          Skip\n                        </button>\n                      </>\n                    )}\n                    \n                    {task.status === 'IN_PROGRESS' && (\n                      <button\n                        onClick={() => handleTaskAction(task, 'complete')}\n                        disabled={actionLoading}\n                        className=\"inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50\"\n                      >\n                        Complete\n                      </button>\n                    )}\n                    \n                    {task.status === 'COMPLETED' && (\n                      <span className=\"inline-flex items-center px-3 py-1.5 text-xs font-medium text-green-700\">\n                        ‚úÖ Done\n                      </span>\n                    )}\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      )}\n\n      {/* Task Completion Modal */}\n      {showCompleteModal && selectedTask && (\n        <div className=\"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50\">\n          <div className=\"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white\">\n            <div className=\"mt-3\">\n              <h3 className=\"text-lg font-medium text-gray-900 mb-4\">\n                Complete Task\n              </h3>\n              \n              <p className=\"text-sm text-gray-600 mb-4\">\n                {selectedTask.name}\n              </p>\n              \n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Completion Notes\n                </label>\n                <textarea\n                  value={completionNote}\n                  onChange={(e) => setCompletionNote(e.target.value)}\n                  rows={4}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"Add any notes or comments about completing this task...\"\n                />\n              </div>\n              \n              <div className=\"flex justify-end space-x-3\">\n                <button\n                  onClick={() => {\n                    setShowCompleteModal(false);\n                    setSelectedTask(null);\n                    setCompletionNote('');\n                  }}\n                  className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={handleCompleteTask}\n                  disabled={actionLoading}\n                  className=\"px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50\"\n                >\n                  {actionLoading ? 'Completing...' : 'Complete Task'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default MyTasks;